name: iOS Build & Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-and-test:
    name: Build and Test on iOS
    runs-on: macos-14

    strategy:
      matrix:
        destination:
          - 'platform=iOS Simulator,name=iPhone 15,OS=17.2'
          - 'platform=iOS Simulator,name=iPad Pro (12.9-inch) (6th generation),OS=17.2'

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'

    - name: Show Xcode Version
      run: xcodebuild -version

    - name: Show Available Simulators
      run: xcrun simctl list devices available

    - name: Cache DerivedData
      uses: actions/cache@v3
      with:
        path: ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-deriveddata-${{ hashFiles('**/*.swift') }}
        restore-keys: |
          ${{ runner.os }}-deriveddata-

    - name: Build Project
      run: |
        xcodebuild clean build \
          -project MathCLI.xcodeproj \
          -scheme MathCLI \
          -destination "${{ matrix.destination }}" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          ONLY_ACTIVE_ARCH=NO

    - name: Run Tests
      run: |
        xcodebuild test \
          -project MathCLI.xcodeproj \
          -scheme MathCLI \
          -destination "${{ matrix.destination }}" \
          -enableCodeCoverage YES \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          ONLY_ACTIVE_ARCH=NO

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.destination }}
        path: |
          ~/Library/Developer/Xcode/DerivedData/*/Logs/Test/*.xcresult
        retention-days: 30

    - name: Upload Code Coverage
      if: success()
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage.xml
        flags: ios
        name: ios-coverage
        fail_ci_if_error: false

  swift-package:
    name: Build Swift Package
    runs-on: macos-14

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'

    - name: Build Swift Package
      run: swift build -c release

    - name: Run Swift Package Tests
      run: swift test

    - name: Build CLI Tool
      run: swift build -c release --product mathcli-tool

    - name: Test CLI Tool
      run: |
        .build/release/mathcli-tool << EOF
        add 5 3
        sqrt 16
        quit
        EOF

  lint:
    name: SwiftLint
    runs-on: macos-14

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install SwiftLint
      run: brew install swiftlint

    - name: Run SwiftLint
      run: swiftlint lint --reporter github-actions-logging

  analyze:
    name: Code Analysis
    runs-on: macos-14

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.2'

    - name: Run Static Analysis
      run: |
        xcodebuild analyze \
          -project MathCLI.xcodeproj \
          -scheme MathCLI \
          -destination 'platform=iOS Simulator,name=iPhone 15' \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO
